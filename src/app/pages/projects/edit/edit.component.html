<app-header></app-header>
<div class="container">
  <div class="row">
    <div class="col-sm-12 col-md-6 col-lg-6 center-content-item">
      <h2 *ngIf="!isNew">
        {{ project.project_name }}
      </h2>
      <form (submit)="proceedToUpdate(false)">
        <div class="form-container">
          <h3>Project config:</h3>
          <div class="form-group required">
            <label for="project_name">Project name</label>
            <input [(ngModel)]="projectModel.project_name"  type="text" class="form-control" name="project_name" placeholder="Enter project name">
            <small class="form-text text-muted">This name will be used for project root folder in ubuntu user home path.</small>
          </div>
          <div class="form-group">
            <label for="desc">Project description</label>
            <textarea [(ngModel)]="projectModel.desc" class="form-control" id="desc" name="desc" rows="3"></textarea>
          </div>
        </div>
        <div class="form-container">
          <h3>Project apps:</h3>
          <div class="app-tabs">
            <div class="app-control">
              <div *ngFor="let model of projectModel.apps; let i = index">
                <a (click)="openTab(model.appId || model.id)" [ngClass]="{'active': activeTab === model.appId || activeTab === model.id}" href="javascript:void(0)">
                  {{ model.app_name || 'App #' + (i + 1) }} <span *ngIf="model.errorMsg" class="text-danger">(validation error)</span>
                </a>
                <button *ngIf="projectModel.apps.length > 1 && !model.id" (click)="removeApp(i)" type="button" class="btn btn-outline-danger">Remove</button>
              </div>
              <div>
                <a (click)="addNewApp()" href="javascript:void(0)" class="action-tab">
                  + Create new app
                </a>
              </div>
            </div>
            <div  *ngFor="let model of projectModel.apps; let pId = index; trackBy: trackByFn" class="app-tab-body {{ model.appId || model.id }}" [ngClass]="{'visible': activeTab === model.appId || activeTab === model.id}">

              <div *ngIf="model.errorMsg" class="alert alert-danger text-center">{{ model.errorMsg }}</div>
              <div class="form-container">
                <div class="form-group required">
                  <label for="app_name">App name</label>
                  <input [(ngModel)]="model.app_name" type="text" class="form-control" name="app_name{{ pId }}" placeholder="Enter app name">
                  <small class="form-text text-muted">Each project could have few applications that are working together or even independently. You can setup only one app at one run of script.</small>
                </div>
                <div class="form-group">
                  <label for="desc{{ pId }}">App description</label>
                  <textarea [(ngModel)]="model.desc" class="form-control" id="desc{{ pId }}" name="desc{{ pId }}" rows="3"></textarea>
                </div>
                <div class="form-group required">
                  <label for="ci_template">CI Template</label>
                  <select [(ngModel)]="projectModel.apps[pId].ci_template" disabled class="form-control" name="ci_template{{ pId }}">
                    <option [value]="'gitlab_ci'"  disabled>GitLab CI</option>
                  </select>
                </div>
                <div class="form-group required">
                  <label for="project_type">App type</label>
                  <select [(ngModel)]="model.project_type" class="form-control" name="project_type{{ pId }}">
                    <option [value]="null"  disabled>Chose app type</option>
                    <ng-container *ngFor="let item of projectTypes">
                      <option *ngIf="projectModel.apps[pId].os !== 'aws_s3' || (projectModel.apps[pId].os === 'aws_s3' && item.s3_support)" [value]="item.id">{{ item.label }}</option>
                    </ng-container>
                  </select>
                </div>
                <div class="form-group required">
                  <label for="environment">App environment</label>
                  <select [(ngModel)]="model.environment" class="form-control" name="environment{{ pId }}">
                    <option [value]="'development'">Development</option>
                    <option [value]="'staging'">Staging</option>
                    <option [value]="'beta'">Beta</option>
                    <option [value]="'production'">Production</option>
                  </select>
                </div>
                <div class="form-group required border-top">
                  <label for="os">OS</label>
                  <select [(ngModel)]="projectModel.apps[pId].os" class="form-control" name="os{{ pId }}">
                    <option [value]="'ubuntu'">Ubuntu OS</option>
                    <option [value]="'aws_s3'">AWS S3 Static website hosting</option>
                  </select>
                </div>
                <div *ngIf="projectModel.apps[pId].os !== 'aws_s3'" class="form-group">
                  <label for="app_port">App port</label>
                  <input [(ngModel)]="model.app_port" type="text" class="form-control" name="app_port{{ pId }}" placeholder="Enter app port">
                  <small class="form-text text-muted">Specify port to be used by application. By default port 8080 is used.</small>
                </div>
                <div *ngIf="projectModel.apps[pId].os !== 'aws_s3'" class="form-group">
                  <label for="avaliable_ports">Avaliable ports</label>
                  <input [(ngModel)]="model.avaliable_ports" type="text" class="form-control" name="avaliable_ports{{ pId }}" placeholder="Enter avaliable ports">
                  <small class="form-text text-muted">This prots will be enabled in firewall</small>
                </div>
              </div>
              <div *ngIf="projectModel.apps[pId].os !== 'aws_s3'" class="form-container">
                <h3>Domain and HTTPS setttings:</h3>
                <div class="form-group" [ngClass]="{'required': model.lets_encrypt}">
                  <label for="domain_name">Domain name</label>
                  <input [(ngModel)]="model.domain_name" type="text" class="form-control" name="domain_name{{ pId }}" placeholder="Enter domain name">
                </div>
                <div class="form-group">
                  <div class="form-check">
                    <input [(ngModel)]="model.lets_encrypt" class="form-check-input" type="checkbox" name="lets_encrypt{{ pId }}">
                    <label class="form-check-label" for="defaultCheck1">
                      Use Let's Encrypt (self-signed certificates)
                    </label>
                  </div>
                </div>
                <div *ngIf="!model.lets_encrypt">
                  <div class="form-group" [ngClass]="{'required': model.custom_ssl_key || model.custom_ssl_crt || model.custom_ssl_key}">
                    <label for="custom_ssl_key">SSL Key file</label>
                    <input (change)="addKeySSLFile($event, model)" type="file" accept=".key" class="form-control" name="custom_ssl_key{{ pId }}" placeholder="Upload SSL Key file">
                    <small *ngIf="projectModel.apps[pId] && projectModel.apps[pId].custom_ssl_key && projectModel.apps[pId].custom_ssl_key.name" class="form-text text-muted">SSL Key: {{ projectModel.apps[pId].custom_ssl_key.name }} <a target="_blank" href="{{api_url}}{{ projectModel.apps[pId].custom_ssl_key.url }}">Download</a></small>
                  </div>
                  <div class="form-group" [ngClass]="{'required': model.custom_ssl_key || model.custom_ssl_crt || model.custom_ssl_key}">
                    <label for="custom_ssl_crt">SSL Crt file</label>
                    <input (change)="addCrtSSLFile($event, model)" type="file" accept=".crt" class="form-control" name="custom_ssl_crt{{ pId }}" placeholder="Upload SSL Crt file">
                    <small *ngIf="projectModel.apps[pId] && projectModel.apps[pId].custom_ssl_crt && projectModel.apps[pId].custom_ssl_crt.name" class="form-text text-muted">SSL Crt: {{ projectModel.apps[pId].custom_ssl_crt.name }} <a target="_blank" href="{{api_url}}{{ projectModel.apps[pId].custom_ssl_crt.url }}">Download</a></small>
                  </div>
                  <div class="form-group" [ngClass]="{'required': model.custom_ssl_key || model.custom_ssl_crt || model.custom_ssl_pem}">
                    <label for="custom_ssl_key">SSL Pem file</label>
                    <input (change)="addPemSSLFile($event, model)" type="file" class="form-control" name="custom_ssl_pem{{ pId }}" placeholder="Upload SSL Pem file">
                    <small *ngIf="projectModel.apps[pId] && projectModel.apps[pId].custom_ssl_pem && projectModel.apps[pId].custom_ssl_pem.name" class="form-text text-muted">SSL Pem: {{ projectModel.apps[pId].custom_ssl_pem.name }} <a target="_blank" href="{{api_url}}{{ projectModel.apps[pId].custom_ssl_pem.url }}">Download</a></small>
                  </div>
                </div>
              </div>

              <button *ngIf="projectModel.apps[pId].app_status === 'success'" (click)="downloadTemplate(projectModel.apps[pId])" style="margin-left: 5px;" type="button" class="btn btn-success">Download CI template</button>

            </div>
          </div>
        </div>
        <div *ngIf="errorMsg" class="alert alert-danger text-center">{{ errorMsg }}</div>
        <button (click)="proceedToUpdate(false)" type="button" class="btn btn-warning">Update</button>
      </form>
    </div>
  </div>
</div>
